<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Phandalin Merchants</title>
<style>
  :root{--w:900px;--ink:#2b211b;--quiet:#6b5b53;--acc:#7a5b3a;--bg:#efe7d5;--edge:#d8c8a9;--rule:rgba(0,0,0,.08);--font:'Iowan Old Style','Palatino Linotype','Book Antiqua',Palatino,serif}
  body{margin:0;background:#1a1a1a;color:var(--ink);font-family:var(--font);line-height:1.35}
  .skin-notice{--bg:#fbf7ed;--edge:#e8dcc1;--acc:#744210}
  .controls{position:sticky;top:0;z-index:5;display:flex;gap:1rem;align-items:center;padding:.7rem 1rem;color:#eee;background:#111;border-bottom:1px solid #222}
  .controls select,.controls input{font:inherit;color:#eee;background:#181818;border:1px solid #333;padding:.35rem .5rem;border-radius:.35rem}
  .sheet{max-width:var(--w);margin:1.1rem auto 1.6rem;padding:1.6rem 1.4rem 1.8rem;position:relative;background:var(--bg,#efe7d5);box-shadow:0 1px 0 rgba(0,0,0,.08),0 10px 30px rgba(0,0,0,.35);border-radius:6px}
  .sheet:before{content:"";position:absolute;inset:0;background:radial-gradient(120% 120% at 50% 110%,transparent 0 70%,rgba(0,0,0,.12) 100%),radial-gradient(65% 60% at 50% -10%,var(--edge,#d8c8a9),transparent 70%);mix-blend-mode:multiply;border-radius:6px}
  header{margin-bottom:.8rem}.title{font-size:clamp(1.45rem,3.5vw,2rem);letter-spacing:.02em;color:var(--acc)}.subtitle{margin:.1rem 0 0;color:var(--quiet);font-style:italic}
  .section{margin:1rem 0;break-inside:avoid}.section h2{font-size:.98rem;letter-spacing:.08em;color:var(--acc);font-variant-caps:small-caps;margin:.45rem 0 .3rem;padding-top:.2rem;border-top:1px solid var(--rule)}
  .items{display:grid;gap:.38rem}
  .line{display:grid;grid-template-columns:1fr auto auto;align-items:baseline;gap:.5rem}
  .name{min-width:0}
  .dots{height:1px;background-image:radial-gradient(circle,currentColor .7px,transparent .7px);background-size:6px 1px;background-repeat:repeat-x;background-position:left bottom;color:var(--quiet);align-self:center}
  .price{white-space:nowrap;font-variant-numeric:tabular-nums}
  .desc{grid-column:1/-1;color:var(--quiet);font-size:.9rem;margin:.05rem 0 0;padding-left:.7rem}
  .hide-gray [data-gray="1"]{display:none}
  footer{margin-top:1rem;display:flex;gap:1rem;align-items:baseline;color:var(--quiet);font-size:.9rem}
  footer .foot-left{flex:1}
  .debug{max-width:var(--w);margin:.5rem auto 0;padding:0 1rem;color:#bbb;font-size:.9rem;white-space:pre-wrap}
  @media print{.controls{display:none!important}body{background:none}.sheet{box-shadow:none;margin:0}}
</style>
</head>
<body>
  <div class="controls">
    <label>Merchant
      <select id="merchantSelect"></select>
    </label>
    <label><input id="underdeskToggle" type="checkbox"> Show under-the-desk</label>
  </div>

  <article id="paper" class="sheet hide-gray">
    <header>
      <div class="title" id="menuTitle">Loading…</div>
      <div class="subtitle" id="menuSubtitle"></div>
    </header>
    <main id="menu"></main>
    <footer>
      <div class="foot-left" id="footLeft"></div>
      <div class="foot-right" id="footRight"></div>
    </footer>
  </article>
  <div class="debug" id="debug"></div>

<script>
/* ====== CONFIG ====== */
var SHEET_ID = "1sKVmkiC_8wpenEXb_692htiNgHv9e0Vz_FLEx4ttqGc"; // share URL doc id
var TAB      = "main";  // your tab name
var PUB_E_ID = "2PACX-1vTJ-jHhfMgMuQryuOFEzBmhgjvaQYeLJ2hwoaVMayEMqFVRfk5CsxZ-wA7-rdpRQ4Bl1CdUC2p0pKrR"; // publish-to-web id
var PUB_GID  = "0";     // <<< REPLACE with the gid you copy from the pubhtml URL for the "main" tab
var DEBUG    = true;    // show source + columns under the paper

/* ====== Utils ====== */
function setDebug(msg){ if(DEBUG){ document.getElementById('debug').textContent = msg; } }
function canon(s){
  return String(s||'').toLowerCase().replace(/\s+/g,' ').replace(/^\s+|\s+$/g,'').replace(/[^\w ]+/g,'').replace(/\s+/g,'_');
}
function toInt(v){ var s=String(v==null?"":v).trim(); if(!s) return null; var n=parseInt(s,10); return isFinite(n)?n:null; }
function toBool(v){ return /^(true|yes|y|1)$/i.test(String(v==null?"":v).trim()); }
function fmtCp(cp){ if(cp==null) return ""; if(cp%100===0) return (cp/100)+"\u00A0gp"; if(cp%10===0) return (cp/10)+"\u00A0sp"; return cp+"\u00A0cp"; }

/* ====== Fetchers ====== */
function gvizUrl(tab){ return "https://docs.google.com/spreadsheets/d/"+SHEET_ID+"/gviz/tq?tqx=out:json&sheet="+encodeURIComponent(tab)+"&t="+Date.now(); }
function csvUrl(id,gid){ return "https://docs.google.com/spreadsheets/d/e/"+id+"/pub?gid="+gid+"&single=true&output=csv&t="+Date.now(); }

function fetchGViz(tab){
  return fetch(gvizUrl(tab), {cache:'no-store'})
    .then(function(r){ if(!r.ok) throw new Error("GViz HTTP "+r.status); return r.text(); })
    .then(function(text){
      var start = text.indexOf('{'), end = text.lastIndexOf('}');
      if (start === -1 || end === -1 || end <= start) throw new Error("GViz wrapper not found");
      var json = JSON.parse(text.slice(start, end+1));
      var cols = json.table.cols.map(function(c){ return c.label || c.id; });
      var keys = cols.map(canon);
      var rows = json.table.rows.map(function(r){
        var o = {}; for (var i=0;i<keys.length;i++){ var c = r.c[i]; o[keys[i]] = (c && c.v!=null) ? c.v : ""; } return o;
      });
      return { rows: rows, cols: cols, keys: keys, source: "GViz" };
    });
}

function fetchCSV(id,gid){
  return fetch(csvUrl(id,gid), {cache:'no-store'})
    .then(function(r){ if(!r.ok) throw new Error("CSV HTTP "+r.status); return r.text(); })
    .then(function(text){
      text = text.replace(/\r/g,'');
      var lines = text.split('\n').filter(function(l){ return l.length; });
      var headers = lines.shift();
      function splitCSV(line){
        var out=[], cur="", inQ=false;
        for(var i=0;i<line.length;i++){
          var ch=line[i];
          if(ch==='"'){ if(inQ && line[i+1]==='"'){ cur+='"'; i++; } else { inQ=!inQ; } }
          else if(ch===',' && !inQ){ out.push(cur); cur=""; }
          else { cur+=ch; }
        }
        out.push(cur); return out;
      }
      var rawCols = splitCSV(headers).map(function(s){ return s.trim(); });
      var keys = rawCols.map(canon);
      var rows = lines.map(function(line){
        var cells = splitCSV(line), o={};
        for(var i=0;i<keys.length;i++){ o[keys[i]] = (cells[i]||"").trim(); }
        return o;
      });
      return { rows: rows, cols: rawCols, keys: keys, source: "CSV (pubweb gid="+gid+")" };
    });
}

/* ====== Build merchants ====== */
function buildMerchants(rows){
  var M = {};
  for (var i=0;i<rows.length;i++){
    var r = rows[i];
    var merchant = String(r.merchant||"").trim();
    var category = String(r.category||"General").trim();
    var item     = String(r.item||"").trim();
    if (!merchant || !item) continue;

    if (!M[merchant]){
      M[merchant] = { key: merchant.toLowerCase().replace(/[^a-z0-9]+/g,''), title: merchant, subtitle: "", allowDescs: !/stonehill/i.test(merchant), footLeft:"", footRight:"", sections: [] };
    }
    var sec = null, secs = M[merchant].sections;
    for (var j=0;j<secs.length;j++){ if (secs[j].title === category){ sec = secs[j]; break; } }
    if(!sec){ sec = { title: category, items: [] }; secs.push(sec); }

    var priceText = String(r.pricetext||"").trim(); if (!priceText) priceText = undefined;
    var cp        = priceText ? undefined : toInt(r.pricecp);
    var gray      = toBool(r.under_the_desk);

    sec.items.push({ name:item, desc:(String(r.description||"").trim()||undefined), cp:cp, priceText:priceText, gray:gray, forceDesc:false });
  }
  return M;
}

/* ====== Rendering ====== */
function setSkin(el, merchantName){ el.classList.remove('skin-notice'); if (/miner/i.test(merchantName)) el.classList.add('skin-notice'); }
function renderMerchant(M, key){
  var m = M[key], paper=document.getElementById('paper'), menu=document.getElementById('menu');
  setSkin(paper, m.title);
  document.getElementById('menuTitle').textContent = m.title;
  document.getElementById('menuSubtitle').textContent = m.subtitle || "";
  document.getElementById('footLeft').textContent = m.footLeft || "";
  document.getElementById('footRight').textContent = m.footRight || "";

  var hideGray = paper.classList.contains('hide-gray'); menu.innerHTML = '';
  for (var si=0; si<m.sections.length; si++){
    var sec = m.sections[si], items = sec.items||[], visible=[];
    for (var k=0;k<items.length;k++){ if (!hideGray || !items[k].gray) visible.push(items[k]); }
    if (!visible.length) continue;

    var wrap=document.createElement('section'); wrap.className='section';
    var h2=document.createElement('h2'); h2.textContent=sec.title; wrap.appendChild(h2);
    var list=document.createElement('div'); list.className='items';

    for (var t=0;t<visible.length;t++){
      var it=visible[t], line=document.createElement('div'); line.className='line'; if(it.gray) line.dataset.gray="1";
      var nm=document.createElement('span'); nm.className='name'; nm.textContent=it.name;
      var dots=document.createElement('span'); dots.className='dots';
      var pr=document.createElement('span'); pr.className='price'; pr.textContent = it.priceText ? it.priceText : fmtCp(it.cp);
      line.appendChild(nm); line.appendChild(dots); line.appendChild(pr);
      if (it.desc && (m.allowDescs || it.forceDesc)){ var d=document.createElement('div'); d.className='desc'; d.textContent=it.desc; line.appendChild(d); }
      list.appendChild(line);
    }
    wrap.appendChild(list); menu.appendChild(wrap);
  }
}

/* ====== Boot (pick best source) ====== */
(function boot(){
  setDebug("Loading data…");
  Promise.allSettled([ fetchGViz(TAB), fetchCSV(PUB_E_ID, PUB_GID) ]).then(function(results){
    var g = results[0].status==="fulfilled" ? results[0].value : null;
    var c = results[1].status==="fulfilled" ? results[1].value : null;

    // Pick the source that yields more merchants
    var choose = function(payload){ 
      var M = buildMerchants(payload.rows);
      var names = Object.keys(M);
      return { M:M, names:names, payload:payload };
    };

    var pick = null, msg="";
    if (g){ var gRes = choose(g); msg += "GViz columns: "+g.cols.join(" | ")+"\n"; msg += "GViz merchants: "+gRes.names.join(", ")+"\n\n"; if (gRes.names.length) pick = gRes; }
    if (!pick && c){ var cRes = choose(c); msg += "CSV columns: "+c.cols.join(" | ")+"\n"; msg += "CSV merchants: "+cRes.names.join(", ")+"\n"; if (cRes.names.length) pick = cRes; }
    setDebug(msg || "No data parsed from either source.");

    if (!pick){ throw new Error("No merchants found from GViz or CSV."); }

    var MERCHANTS = pick.M, names = pick.names;

    // Fill dropdown + handlers
    var select = document.getElementById('merchantSelect'), byKey={};
    names.sort(function(a,b){ var sa=/stonehill/i.test(a)?-1:0, sb=/stonehill/i.test(b)?-1:0; return (sa-sb)||a.localeCompare(b); });
    for (var i=0;i<names.length;i++){ var m=MERCHANTS[names[i]]; byKey[m.key]=m; var opt=document.createElement('option'); opt.value=m.key; opt.textContent=names[i]; select.appendChild(opt); }
    select.addEventListener('change', function(e){ renderMerchant(byKey, e.target.value); });
    document.getElementById('underdeskToggle').addEventListener('change', function(e){ document.getElementById('paper').classList.toggle('hide-gray', !e.target.checked); renderMerchant(byKey, select.value); });

    var firstKey = byKey['stonehillinn'] ? 'stonehillinn' : byKey[MERCHANTS[names[0]].key].key;
    select.value = firstKey; renderMerchant(byKey, firstKey);
  }).catch(function(err){
    document.getElementById('menuTitle').textContent = 'Load failed';
    document.getElementById('menu').textContent = 'Could not load data from GViz or CSV. Check: 1) Sheet sharing “Anyone with the link: Viewer”. 2) Tab name "'+TAB+'". 3) Publish-to-web gid='+PUB_GID+' points to the right tab.';
  });
})();
</script>
</body>
</html>
