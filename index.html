<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Phandalin Merchants</title>
<style>
  :root{--w:900px;--ink:#2b211b;--quiet:#6b5b53;--acc:#7a5b3a;--bg:#efe7d5;--edge:#d8c8a9;--rule:rgba(0,0,0,.08);--gink:#6b6b6b;--crest:#6e5436;--font:'Iowan Old Style','Palatino Linotype','Book Antiqua',Palatino,serif}
  body{margin:0;background:#1a1a1a;color:var(--ink);font-family:var(--font);line-height:1.35}
  .skin-notice{--bg:#fbf7ed;--edge:#e8dcc1;--acc:#744210;--crest:#8a5a2b}
  .controls{position:sticky;top:0;z-index:5;display:flex;gap:1rem;align-items:center;padding:.7rem 1rem;color:#eee;background:#111;border-bottom:1px solid #222}
  .controls select,.controls input{font:inherit;color:#eee;background:#181818;border:1px solid #333;padding:.35rem .5rem;border-radius:.35rem}
  .sheet{max-width:var(--w);margin:1.1rem auto 1.6rem;padding:1.6rem 1.4rem 1.8rem;position:relative;background:var(--bg,#efe7d5);box-shadow:0 1px 0 rgba(0,0,0,.08),0 10px 30px rgba(0,0,0,.35);border-radius:6px}
  .sheet:before{content:"";position:absolute;inset:0;background:radial-gradient(120% 120% at 50% 110%,transparent 0 70%,rgba(0,0,0,.12) 100%),radial-gradient(65% 60% at 50% -10%,var(--edge,#d8c8a9),transparent 70%);mix-blend-mode:multiply;border-radius:6px}
  header{margin-bottom:.8rem}.title{font-size:clamp(1.45rem,3.5vw,2rem);letter-spacing:.02em;color:var(--acc)}.subtitle{margin:.1rem 0 0;color:var(--quiet);font-style:italic}
  .section{margin:1rem 0;break-inside:avoid}.section h2{font-size:.98rem;letter-spacing:.08em;color:var(--acc);font-variant-caps:small-caps;margin:.45rem 0 .3rem;padding-top:.2rem;border-top:1px solid var(--rule)}
  .items{display:grid;gap:.38rem}
  .line{display:grid;grid-template-columns:1fr auto auto;align-items:baseline;gap:.5rem}
  .name{min-width:0}.dots{height:1px;background-image:radial-gradient(circle,currentColor .7px,transparent .7px);background-size:6px 1px;background-repeat:repeat-x;background-position:left bottom;color:var(--quiet);align-self:center}
  .price{white-space:nowrap;font-variant-numeric:tabular-nums}
  .desc{grid-column:1/-1;color:var(--quiet);font-size:.9rem;margin:.05rem 0 0;padding-left:.7rem}
  .hide-gray [data-gray="1"]{display:none}
  footer{margin-top:1rem;display:flex;gap:1rem;align-items:baseline;color:var(--quiet);font-size:.9rem}
  footer .foot-left{flex:1}
  @media print{.controls{display:none!important}body{background:none}.sheet{box-shadow:none;margin:0}}
</style>
</head>
<body>
  <div class="controls">
    <label>Merchant
      <select id="merchantSelect"></select>
    </label>
    <label><input id="underdeskToggle" type="checkbox"> Show under-the-desk</label>
  </div>

  <article id="paper" class="sheet hide-gray">
    <header>
      <div class="title" id="menuTitle">Loading…</div>
      <div class="subtitle" id="menuSubtitle"></div>
    </header>
    <main id="menu"></main>
    <footer>
      <div class="foot-left" id="footLeft"></div>
      <div class="foot-right" id="footRight"></div>
    </footer>
  </article>

<script>
/* ====== CONFIG: your sheet ====== */
const SHEET_ID = "1sKVmkiC_8wpenEXb_692htiNgHv9e0Vz_FLEx4ttqGc";
const TAB      = "main";

/* ====== Fetch rows via GViz JSON (works with “Anyone with the link: Viewer”) ====== */
const gvizUrl = (tab) =>
  `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(tab)}&t=${Date.now()}`;

async function fetchGViz(tab){
  const text = await fetch(gvizUrl(tab), {cache:'no-store'}).then(r=>r.text());
  const json = JSON.parse(text.slice(47, -2)); // strip GViz wrapper
  const cols = json.table.cols.map(c => c.label || c.id);
  return json.table.rows.map(r => {
    const obj = {};
    r.c.forEach((cell,i)=> obj[cols[i]] = (cell && cell.v != null) ? String(cell.v) : "");
    return obj;
  });
}

/* ====== Transform flat rows -> merchants structure ====== */
function normalizeBool(v){
  const s = String(v).trim().toLowerCase();
  return s === "true" || s === "yes" || s === "y" || s === "1";
}
function toIntOrNull(v){
  if (v === null || v === undefined) return null;
  const s = String(v).trim();
  if (!s) return null;
  const n = parseInt(s, 10);
  return Number.isFinite(n) ? n : null;
}
function fmtCp(cp){
  if (cp == null) return "";
  if (cp % 100 === 0) return (cp/100) + "\u00A0gp";
  if (cp % 10  === 0) return (cp/10)  + "\u00A0sp";
  return cp + "\u00A0cp";
}
function setSkin(el, merchantName){
  // Defaults: parchment everywhere; Miner’s Exchange uses noticeboard.
  el.classList.remove('skin-notice');
  if (/miner/i.test(merchantName)) el.classList.add('skin-notice');
}

function buildMerchants(rows){
  const M = {};
  for (const row of rows){
    const merchant = (row["Merchant"]||"").trim();
    const category = (row["Category"]||"General").trim();
    const itemName = (row["Item"]||"").trim();
    if (!merchant || !itemName) continue;

    if (!M[merchant]){
      M[merchant] = {
        key: merchant.toLowerCase().replace(/[^a-z0-9]+/g,''),
        title: merchant,
        subtitle: "",         // optional column could be added later
        allowDescs: !/stonehill/i.test(merchant), // Stonehill shows no descriptions
        footLeft: "",         // could add FootLeft/Right columns later
        footRight: "",
        sections: []
      };
    }
    let sec = M[merchant].sections.find(s => s.title === category);
    if(!sec){ sec = { title: category, items: [] }; M[merchant].sections.push(sec); }

    const priceCp   = toIntOrNull(row["PriceCp"]);
    const priceText = (row["PriceText"]||"").trim() || undefined;
    const grayCol   = row["Under the desk?"]; // exact header as you wrote it
    const gray      = normalizeBool(grayCol);

    sec.items.push({
      name: itemName,
      desc: (row["Description"]||"").trim() || undefined,
      cp: priceText ? undefined : priceCp, // if PriceText present, prefer that
      priceText,
      gray,
      forceDesc: false
    });
  }
  return M;
}

/* ====== Rendering ====== */
function renderMerchant(M, key){
  const m = M[key];
  const paper = document.getElementById('paper');
  const menu  = document.getElementById('menu');

  setSkin(paper, m.title);
  document.getElementById('menuTitle').textContent   = m.title;
  document.getElementById('menuSubtitle').textContent= m.subtitle || "";
  document.getElementById('footLeft').textContent    = m.footLeft || "";
  document.getElementById('footRight').textContent   = m.footRight || "";

  const hideGray = paper.classList.contains('hide-gray');
  menu.innerHTML = '';

  for (const sec of m.sections){
    const items = Array.isArray(sec.items) ? sec.items : [];
    const visible = hideGray ? items.filter(i => !i.gray) : items;
    if (visible.length === 0) continue; // hide all-gray sections until toggle

    const wrap = document.createElement('section');
    wrap.className = 'section';
    const h2 = document.createElement('h2');
    h2.textContent = sec.title;
    wrap.appendChild(h2);

    const list = document.createElement('div');
    list.className = 'items';

    for (const it of visible){
      const line = document.createElement('div');
      line.className = 'line';
      if (it.gray) line.dataset.gray = "1";

      const nm = document.createElement('span'); nm.className = 'name'; nm.textContent = it.name;
      const dots = document.createElement('span'); dots.className = 'dots';
      const pr = document.createElement('span'); pr.className = 'price';
      pr.textContent = it.priceText ?? fmtCp(it.cp);

      line.append(nm, dots, pr);

      if (it.desc && (m.allowDescs || it.forceDesc)){
        const d = document.createElement('div'); d.className = 'desc'; d.textContent = it.desc;
        line.appendChild(d);
      }
      list.appendChild(line);
    }
    wrap.appendChild(list);
    menu.appendChild(wrap);
  }
}

/* ====== Boot ====== */
(async function boot(){
  try {
    const rows = await fetchGViz(TAB);
    const MERCHANTS = buildMerchants(rows);

    // Fill dropdown
    const select = document.getElementById('merchantSelect');
    const names = Object.keys(MERCHANTS);
    // prefer Stonehill if present
    names.sort((a,b)=> (/stonehill/i.test(a)?-1:0) - (/stonehill/i.test(b)?-1:0) || a.localeCompare(b));
    for (const name of names){
      const opt = document.createElement('option');
      opt.value = MERCHANTS[name].key;
      opt.textContent = name;
      select.appendChild(opt);
    }

    // Build key map
    const byKey = {};
    for (const name of names){ byKey[MERCHANTS[name].key] = MERCHANTS[name]; }

    // Handlers
    select.addEventListener('change', e => renderMerchant(byKey, e.target.value));
    document.getElementById('underdeskToggle').addEventListener('change', e => {
      document.getElementById('paper').classList.toggle('hide-gray', !e.target.checked);
      renderMerchant(byKey, select.value);
    });

    // First render
    const firstKey = byKey['stonehillinn'] ? 'stonehillinn' : byKey[names[0].toLowerCase().replace(/[^a-z0-9]+/g,'')].key;
    select.value = firstKey;
    renderMerchant(byKey, firstKey);
  } catch (err){
    console.error(err);
    document.getElementById('menu').textContent = 'Could not load data. Check sharing (Viewer), tab name “main”, and column headers.';
  }
})();
</script>
</body>
</html>
