<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Phandalin Merchants</title>
<style>
  :root{--w:900px;--ink:#2b211b;--quiet:#6b5b53;--acc:#7a5b3a;--bg:#efe7d5;--edge:#d8c8a9;--rule:rgba(0,0,0,.08);--font:'Iowan Old Style','Palatino Linotype','Book Antiqua',Palatino,serif}
  body{margin:0;background:#1a1a1a;color:var(--ink);font-family:var(--font);line-height:1.35}
  .skin-notice{--bg:#fbf7ed;--edge:#e8dcc1;--acc:#744210}
  .controls{position:sticky;top:0;z-index:5;display:flex;gap:1rem;align-items:center;padding:.7rem 1rem;color:#eee;background:#111;border-bottom:1px solid #222}
  .controls select,.controls input{font:inherit;color:#eee;background:#181818;border:1px solid #333;padding:.35rem .5rem;border-radius:.35rem}
  .sheet{max-width:var(--w);margin:1.1rem auto 1.6rem;padding:1.6rem 1.4rem 1.8rem;position:relative;background:var(--bg,#efe7d5);box-shadow:0 1px 0 rgba(0,0,0,.08),0 10px 30px rgba(0,0,0,.35);border-radius:6px}
  .sheet:before{content:"";position:absolute;inset:0;background:radial-gradient(120% 120% at 50% 110%,transparent 0 70%,rgba(0,0,0,.12) 100%),radial-gradient(65% 60% at 50% -10%,var(--edge,#d8c8a9),transparent 70%);mix-blend-mode:multiply;border-radius:6px}
  header{margin-bottom:.8rem}.title{font-size:clamp(1.45rem,3.5vw,2rem);letter-spacing:.02em;color:var(--acc)}.subtitle{margin:.1rem 0 0;color:var(--quiet);font-style:italic}
  .section{margin:1rem 0;break-inside:avoid}.section h2{font-size:.98rem;letter-spacing:.08em;color:var(--acc);font-variant-caps:small-caps;margin:.45rem 0 .3rem;padding-top:.2rem;border-top:1px solid var(--rule)}
  .items{display:grid;gap:.38rem}
  .line{display:grid;grid-template-columns:1fr auto auto;align-items:baseline;gap:.5rem}
  .name{min-width:0}
  .dots{height:1px;background-image:radial-gradient(circle,currentColor .7px,transparent .7px);background-size:6px 1px;background-repeat:repeat-x;background-position:left bottom;color:var(--quiet);align-self:center}
  .price{white-space:nowrap;font-variant-numeric:tabular-nums}
  .desc{grid-column:1/-1;color:var(--quiet);font-size:.9rem;margin:.05rem 0 0;padding-left:.7rem}
  .hide-gray [data-gray="1"]{display:none}
  footer{margin-top:1rem;display:flex;gap:1rem;align-items:baseline;color:var(--quiet);font-size:.9rem}
  footer .foot-left{flex:1}
  @media print{.controls{display:none!important}body{background:none}.sheet{box-shadow:none;margin:0}}
</style>
</head>
<body>
  <div class="controls">
    <label>Merchant
      <select id="merchantSelect"></select>
    </label>
    <label><input id="underdeskToggle" type="checkbox"> Show under-the-desk</label>
  </div>

  <article id="paper" class="sheet hide-gray">
    <header>
      <div class="title" id="menuTitle">Loading…</div>
      <div class="subtitle" id="menuSubtitle"></div>
    </header>
    <main id="menu"></main>
    <footer>
      <div class="foot-left" id="footLeft"></div>
      <div class="foot-right" id="footRight"></div>
    </footer>
  </article>

<script>
/* ====== CONFIG ====== */
var SHEET_ID = "1sKVmkiC_8wpenEXb_692htiNgHv9e0Vz_FLEx4ttqGc";
var TAB      = "main";           // your tab name (lowercase as you set it)
var DEBUG    = location.search.indexOf('debug=1') !== -1;

/* ====== GViz fetch (no dotAll flag) ====== */
function gvizUrl(tab){
  return "https://docs.google.com/spreadsheets/d/"+SHEET_ID+"/gviz/tq?tqx=out:json&sheet="+encodeURIComponent(tab)+"&t="+Date.now();
}
function canon(s){
  return String(s||'')
    .toLowerCase()
    .replace(/\s+/g,' ')
    .replace(/^\s+|\s+$/g,'')
    .replace(/[^\w ]+/g,'')
    .replace(/\s+/g,'_');
}
function fetchGViz(tab){
  return fetch(gvizUrl(tab), {cache:'no-store'})
    .then(function(r){ return r.text(); })
    .then(function(text){
      // Match across newlines without /s by using [\s\S]*
      var m = text.match(/google\.visualization\.Query\.setResponse\(([\s\S]*)\);\s*$/);
      if(!m){ throw new Error("GViz response not recognised; check sharing (Viewer) and tab name."); }
      var json = JSON.parse(m[1]);
      var cols = json.table.cols.map(function(c){ return c.label || c.id; });
      var keys = cols.map(canon);
      if (DEBUG) console.log("GViz columns:", cols, "→", keys);
      return json.table.rows.map(function(r){
        var row = {};
        for(var i=0;i<keys.length;i++){
          var cell = r.c[i];
          row[keys[i]] = (cell && cell.v!=null) ? cell.v : "";
        }
        return row;
      });
    });
}

/* ====== Helpers (no ??) ====== */
function toInt(v){
  var s = String(v==null?"":v).trim();
  if(!s) return null;
  var n = parseInt(s,10);
  return isFinite(n) ? n : null;
}
function toBool(v){
  return /^(true|yes|y|1)$/i.test(String(v==null?"":v).trim());
}
function fmtCp(cp){
  if (cp==null) return "";
  if (cp%100===0) return (cp/100)+"\u00A0gp";
  if (cp%10===0)  return (cp/10)+"\u00A0sp";
  return cp+"\u00A0cp";
}

/* ====== Build merchants from rows ====== */
function buildMerchants(rows){
  var M = {};
  for (var i=0;i<rows.length;i++){
    var r = rows[i];
    var merchant = String(r.merchant||"").trim();
    var category = String(r.category||"General").trim();
    var item     = String(r.item||"").trim();
    if (!merchant || !item) continue;

    if (!M[merchant]){
      M[merchant] = {
        key: merchant.toLowerCase().replace(/[^a-z0-9]+/g,''),
        title: merchant,
        subtitle: "",
        allowDescs: !/stonehill/i.test(merchant),
        footLeft: "", footRight: "",
        sections: []
      };
    }
    var sec = null;
    for (var j=0;j<M[merchant].sections.length;j++){
      if (M[merchant].sections[j].title === category){ sec = M[merchant].sections[j]; break; }
    }
    if(!sec){ sec = { title: category, items: [] }; M[merchant].sections.push(sec); }

    var priceText = String(r.pricetext||"").trim();
    if (!priceText) priceText = undefined;
    var cp        = priceText ? undefined : toInt(r.pricecp);
    var gray      = toBool(r.under_the_desk); // from “Under the desk?”

    sec.items.push({
      name: item,
      desc: (String(r.description||"").trim() || undefined),
      cp: cp, priceText: priceText,
      gray: gray,
      forceDesc: false
    });
  }
  if (DEBUG) console.log("Parsed merchants:", Object.keys(M));
  return M;
}

/* ====== Rendering ====== */
function setSkin(el, merchantName){
  el.classList.remove('skin-notice');
  if (/miner/i.test(merchantName)) el.classList.add('skin-notice'); // noticeboard for Miner’s Exchange
}
function renderMerchant(M, key){
  var m = M[key];
  var paper = document.getElementById('paper');
  var menu  = document.getElementById('menu');

  setSkin(paper, m.title);
  document.getElementById('menuTitle').textContent = m.title;
  document.getElementById('menuSubtitle').textContent = m.subtitle || "";
  document.getElementById('footLeft').textContent = m.footLeft || "";
  document.getElementById('footRight').textContent = m.footRight || "";

  var hideGray = paper.classList.contains('hide-gray');
  menu.innerHTML = '';

  for (var si=0; si<m.sections.length; si++){
    var sec = m.sections[si];
    var items = sec.items || [];
    var visible = [];
    for (var k=0;k<items.length;k++){
      if (!hideGray || !items[k].gray) visible.push(items[k]);
    }
    if (visible.length === 0) continue;

    var wrap = document.createElement('section');
    wrap.className = 'section';
    var h2 = document.createElement('h2'); h2.textContent = sec.title;
    wrap.appendChild(h2);

    var list = document.createElement('div');
    list.className = 'items';

    for (var t=0;t<visible.length;t++){
      var it = visible[t];
      var line = document.createElement('div');
      line.className = 'line';
      if (it.gray) line.dataset.gray = "1";

      var nm = document.createElement('span'); nm.className='name'; nm.textContent = it.name;
      var dots = document.createElement('span'); dots.className='dots';
      var pr = document.createElement('span'); pr.className='price';
      pr.textContent = it.priceText ? it.priceText : fmtCp(it.cp);

      line.appendChild(nm); line.appendChild(dots); line.appendChild(pr);

      if (it.desc && (m.allowDescs || it.forceDesc)){
        var d = document.createElement('div'); d.className='desc'; d.textContent = it.desc;
        line.appendChild(d);
      }
      list.appendChild(line);
    }
    wrap.appendChild(list);
    menu.appendChild(wrap);
  }
}

/* ====== Boot ====== */
(function boot(){
  fetchGViz(TAB).then(function(rows){
    var MERCHANTS = buildMerchants(rows);
    var names = Object.keys(MERCHANTS);
    if (names.length === 0) throw new Error("No rows parsed – check headers/values in the sheet.");

    var select = document.getElementById('merchantSelect');
    names.sort(function(a,b){
      var sa = /stonehill/i.test(a) ? -1 : 0;
      var sb = /stonehill/i.test(b) ? -1 : 0;
      return (sa - sb) || a.localeCompare(b);
    });

    var byKey = {};
    for (var i=0;i<names.length;i++){
      var m = MERCHANTS[names[i]];
      byKey[m.key] = m;
      var opt = document.createElement('option');
      opt.value = m.key; opt.textContent = names[i];
      select.appendChild(opt);
    }

    select.addEventListener('change', function(e){ renderMerchant(byKey, e.target.value); });
    document.getElementById('underdeskToggle').addEventListener('change', function(e){
      document.getElementById('paper').classList.toggle('hide-gray', !e.target.checked);
      renderMerchant(byKey, select.value);
    });

    var firstKey = byKey['stonehillinn'] ? 'stonehillinn' : byKey[MERCHANTS[names[0]].key].key;
    select.value = firstKey;
    renderMerchant(byKey, firstKey);
  }).catch(function(err){
    console.error(err);
    document.getElementById('menuTitle').textContent = 'Load failed';
    document.getElementById('menu').textContent =
      'Could not load data. Add “?debug=1” to the URL and open the console for details. ' +
      'Fixes: Share sheet as “Anyone with the link: Viewer”, verify tab name “‘+TAB+'”, '+
      'and ensure rows have Merchant, Item, and a PriceCp or PriceText.';
  });
})();
</script>
</body>
</html>
