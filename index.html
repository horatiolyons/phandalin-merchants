<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Phandalin Merchants</title>
  <style>
    :root{
      --ink:#2b211b; --quiet:#6b5b53; --accent:#7a5b3a;
      --paper:#efe7d5; --paper-edge:#d8c8a9; --rule: rgba(0,0,0,.08);
      --crest:#8a5a2b; --w:900px;
    }
    .skin-parchment{ --paper:#efe7d5; --paper-edge:#d8c8a9; --accent:#7a5b3a; }
    .skin-noticeboard{ --paper:#fbf7ed; --paper-edge:#e8dcc1; --accent:#744210; }

    html,body{margin:0;padding:0;background:#e8e0cf;color:var(--ink);}
    body{font-family:'Iowan Old Style','Palatino Linotype','Book Antiqua',Palatino,serif; line-height:1.35;}
    .wrap{max-width:var(--w); margin:0 auto; padding:0 12px;}

    nav.controls{
      position:sticky; top:0; z-index:10;
      background:rgba(30,22,18,.9); color:#f6f0e6;
      border-bottom:1px solid rgba(255,255,255,.08); backdrop-filter: blur(2px);
    }
    .controls .inner{ display:flex; align-items:center; gap:.8rem; padding:.5rem .8rem; }
    .controls label{font-size:.95rem;}
    .controls select, .controls input[type="checkbox"]{ accent-color:#c5a77b; }
    .controls select{
      background:#f6f0e6; color:#221a16; border:1px solid #b8a58b; border-radius:4px; padding:.25rem .5rem;
    }
    .spacer{flex:1}

    main{padding:1.1rem 0 2rem;}
    .paper{
      background:var(--paper); margin:0 auto; border-radius:6px;
      box-shadow: 0 12px 28px rgba(0,0,0,.12), 0 2px 6px rgba(0,0,0,.08);
      position:relative; overflow:hidden;
    }
    .paper::before{
      content:""; position:absolute; inset:0;
      background:
        radial-gradient(120% 40% at 50% -10%, var(--paper-edge), transparent 60%),
        radial-gradient(100% 120% at 50% 120%, rgba(0,0,0,.06), transparent 60%);
      mix-blend-mode:multiply; pointer-events:none;
    }
    .paper .pad{padding:1.4rem 1.2rem;}

    /* Header row with crest + subtitle */
    .head{ display:flex; align-items:center; gap:.75rem; margin:0 0 .25rem 0; }
    .title{ flex:1; min-width:0; }
    .title h2{ margin:.2rem 0 .15rem 0; font-size:1.8rem; color:var(--accent); }
    .subtitle{
      color:var(--quiet); font-size:1rem; letter-spacing:.02em;
      margin:0 0 .05rem 0;
    }
    .crest[hidden]{ display:none !important; }
    .crest{ width:72px; height:72px; flex:0 0 auto; }
    .crest img{ display:block; width:100%; height:100%; object-fit:contain; }

    @media (max-width: 640px){
      .crest{ width:52px; height:52px; }
      .title h2{ font-size:1.6rem; }
      .subtitle{ font-size:.98rem; }
    }

    h3{
      margin:.45rem 0 .3rem; padding-top:.45rem; border-top:1px solid var(--rule);
      font-variant: small-caps; letter-spacing:.08em; font-size:1.05rem; color:var(--accent);
    }

    .section{break-inside:avoid; page-break-inside:avoid;}
    .items{margin:0; padding:0; list-style:none;}
    .item{
      display:grid; grid-template-columns: minmax(0,1fr) auto; grid-column-gap:.35rem;
      align-items:end; margin:0; padding:0;
    }
    .item + .item{ margin-top:.38rem; }
    .item.btc{ border-left:2px solid var(--rule); padding-left:.55rem; } /* ledger margin */

    .name{ min-width:0; overflow-wrap:anywhere; }
    .line{ display:flex; align-items:flex-end; gap:.35rem; }
    .dots{
      flex:1 1 auto; height:1px; transform:translateY(-2px);
      background-image: radial-gradient(circle, currentColor .7px, transparent .7px);
      background-size: 6px 1px; background-repeat: repeat-x; opacity:.55;
    }
    .price{ white-space:nowrap; font-variant-numeric: tabular-nums; justify-self:end; }
    .desc{ grid-column:1 / -1; font-size:.95rem; color:var(--quiet); margin:.08rem 0 0 0; padding-left:.7rem; }

    .footer{
      display:flex; gap:.8rem; margin-top:1rem; color:var(--quiet);
      border-top:1px solid var(--rule); padding-top:.6rem;
    }
    .footLeft{flex:1} .footRight{text-align:right; flex:1}

    #btcWrap[hidden]{ display:none !important; }
    .muted{ opacity:.7; }

    /* Lock icon button */
    .icon-btn{
      background:none; border:none; padding:.1rem .25rem; margin-left:.25rem;
      cursor:pointer; color:var(--quiet);
    }
    .icon-btn .ico{ width:1.1rem; height:1.1rem; vertical-align:-2px; }
    .icon-btn.is-unlocked{ color:var(--crest); }
    @media (prefers-reduced-motion:no-preference){
      .icon-btn:is(:hover,:focus-visible) .ico{ transform:translateY(-1px); transition:transform .12s ease; }
    }
    .icon-btn:focus{ outline:2px solid #e7d6b6; outline-offset:2px; border-radius:3px; }

    .sr-only{
      position:absolute; width:1px; height:1px; padding:0; margin:-1px;
      overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0;
    }

    /* Mobile improvement: cap price width + allow wrapping */
    @media (max-width: 640px){
      .item{ grid-template-columns: minmax(0, 1fr) minmax(0, 45%); }
      .price{ white-space: normal; text-align: right; }
    }

    @media print{
      nav.controls{display:none !important;}
      body{background:var(--paper);}
      .paper{box-shadow:none;}
      .crest{ opacity:.9; }
    }
  </style>
</head>
<body>
  <a href="#main" class="sr-only">Skip to content</a>

  <nav class="controls" aria-label="Menu controls">
    <div class="wrap inner">
      <label for="merchant">Merchant</label>
      <select id="merchant" name="merchant" aria-label="Select merchant"></select>
      <div class="spacer"></div>

      <span id="btcWrap">
        <label class="muted">
          <input type="checkbox" id="btcToggle" /> Show below counter
        </label>
        <button id="btcLockBtn" type="button" class="icon-btn" title="Unlock below-counter items" aria-label="Unlock below-counter items">
          <svg class="ico" aria-hidden="true"><use href="#ico-lock-closed"/></svg>
        </button>
      </span>
    </div>
  </nav>

  <!-- Inline SVG lock symbols -->
  <svg width="0" height="0" style="position:absolute"><defs>
    <symbol id="ico-lock-closed" viewBox="0 0 24 24">
      <path fill="none" stroke="currentColor" stroke-width="1.75"
        d="M7 10h10a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-6a2 2 0 0 1 2-2zm2 0V8a3 3 0 1 1 6 0v2"/>
    </symbol>
    <symbol id="ico-lock-open" viewBox="0 0 24 24">
      <path fill="none" stroke="currentColor" stroke-width="1.75"
        d="M7 10h10a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-6a2 2 0 1 1 2-2zm8-2V6a3 3 0 1 0-6 0"/>
    </symbol>
  </defs></svg>

  <main id="main">
    <div class="wrap">
      <article id="paper" class="paper skin-parchment" aria-live="polite">
        <div class="pad" id="paperInner"></div>
      </article>
    </div>
  </main>

  <script>
    // =========================
    // CONFIG
    // =========================
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTJ-jHhfMgMuQryuOFEzBmhgjvaQYeLJ2hwoaVMayEMqFVRfk5CsxZ-wA7-rdpRQ4Bl1CdUC2p0pKrR/pub?output=csv";
    const FIXED_ORDER = ["Stonehill Inn","Barthen’s Provisions","Hilda’s Remedies","Miner’s Exchange"];
    const MERCHANT_SKIN = {
      "stonehill-inn":"skin-parchment",
      "barthens-provisions":"skin-parchment",
      "hildas-remedies":"skin-parchment",
      "miners-exchange":"skin-noticeboard"
    };
    const PASSPHRASE = {
      "stonehill-inn":"tankard",
      "barthens-provisions":"buddy",
      "hildas-remedies":"tincture",
      "miners-exchange":"assay"
    };

    // =========================
    // UTILITIES
    // =========================
    const $ = (s,el=document)=>el.querySelector(s);

    function slugify(s){
      return (s||"").toString()
        .normalize("NFKD")
        .replace(/[\u2019\u2018]/g,"'")
        .replace(/'/g,"")
        .replace(/&/g,"and")
        .replace(/[^a-z0-9]+/gi,"-")
        .replace(/^-+|-+$/g,"")
        .toLowerCase();
    }
    function parseCSV(text){
      const rows=[]; let i=0,f="",row=[],q=false;
      const pushF=()=>{row.push(f);f="";}; const pushR=()=>{rows.push(row);row=[];};
      while(i<text.length){ const c=text[i];
        if(q){ if(c=='"'){ if(text[i+1]=='"'){f+='"';i++;} else q=false; } else f+=c; }
        else { if(c=='"') q=true; else if(c==',') pushF(); else if(c=='\r'){} else if(c=='\n'){pushF();pushR();} else f+=c; }
        i++;
      }
      if(f.length>0||row.length>0){pushF();pushR();}
      return rows;
    }
    const toBool = v => (v||"").toString().trim().toUpperCase()==="TRUE";
    function fmtPriceCp(cp){
      if(cp==null||cp==="") return "—";
      const n=Number(cp); if(!Number.isFinite(n)) return "—";
      if(n%100===0) return (n/100)+"\u00A0gp";
      if(n%10===0)  return (n/10)+"\u00A0sp";
      return n+"\u00A0cp";
    }
    const nb = s => (s||"").toString().replace(/\s/g,"\u00A0");
    function addWrapHints(priceStr){ return nb(priceStr).replace(/·/g, '·<wbr>'); }

    // =========================
    // DATA
    // =========================
    let RAW=[], MERCHANTS=[], HAS_BTC={};

    async function loadData(){
      const res=await fetch(CSV_URL,{cache:"no-store"});
      if(!res.ok) throw new Error("Failed to fetch CSV");
      const txt=await res.text();
      const rows=parseCSV(txt);
      const [hdr,...body]=rows;
      const idx={}; hdr.forEach((h,i)=>idx[h.trim().toLowerCase()]=i);

      RAW = body
        .filter(r=>r.length && r.some(c=>c&&c.trim()!==""))
        .map((r,i)=>({
          __i:i,
          sort:Number(r[idx["sort"]]??""),
          merchant:(r[idx["merchant"]]??"").trim(),
          subtitle:(r[idx["subtitle"]]??"").trim(),               // NEW
          subtitle_btc:(r[idx["subtitle_btc"]]??"").trim(),       // optional
          section:(r[idx["section"]]??"").trim(),
          item:(r[idx["item"]]??"").trim(),
          description:(r[idx["description"]]??"").trim(),
          price_cp:(r[idx["price_cp"]]??"").trim(),
          price_text:(r[idx["price_text"]]??"").trim(),
          is_btc:toBool(r[idx["is_btc"]])
        }));

      const set=new Set(RAW.map(r=>r.merchant).filter(Boolean));
      MERCHANTS = Array.from(set);

      HAS_BTC = {};
      for(const r of RAW){ if(r.is_btc && r.merchant){ HAS_BTC[slugify(r.merchant)] = true; } }

      initUI();
      render();
    }

    // =========================
    // STATE/ELS
    // =========================
    const els={
      merchant:$("#merchant"),
      btc:$("#btcToggle"),
      btcWrap:$("#btcWrap"),
      lockBtn:$("#btcLockBtn"),
      paper:$("#paper"),
      paperInner:$("#paperInner")
    };
    const getPassState=()=>{ try{return JSON.parse(localStorage.getItem("btcPass")||"{}");}catch{return{}} };
    const setPassState=o=>localStorage.setItem("btcPass",JSON.stringify(o||{}));
    const getShownState=()=>{ try{return JSON.parse(localStorage.getItem("btcShown")||"{}");}catch{return{}} };
    const setShownState=o=>localStorage.setItem("btcShown",JSON.stringify(o||{}));

    const currentMerchant = ()=>els.merchant.value;
    const merchantSlugToName = slug => MERCHANTS.find(m=>slugify(m)===slug) || slug;
    const merchantHasBTC = slug => !!HAS_BTC[slug];
    const merchantUnlocked = slug => !!getPassState()[slug];

    // =========================
    // UI INIT
    // =========================
    function initUI(){
      const fixed = FIXED_ORDER.filter(n=>MERCHANTS.includes(n));
      const extras = MERCHANTS.filter(m=>!fixed.includes(m)).sort((a,b)=>a.localeCompare(b));
      const order=[...fixed,...extras];

      els.merchant.innerHTML = order.map(n=>`<option value="${slugify(n)}">${n}</option>`).join("");

      const hash=new URLSearchParams(location.hash.slice(1));
      const desired=hash.get("merchant");
      const defaultSlug=slugify(order[0]||"");
      els.merchant.value = desired && order.some(n=>slugify(n)===desired) ? desired : defaultSlug;

      applyBtcVisibility();

      els.merchant.addEventListener("change",()=>{ applyBtcVisibility(); render(); });
      els.btc.addEventListener("change", ()=>{
        const slug=currentMerchant();
        if(merchantHasBTC(slug) && merchantUnlocked(slug)){
          const shown=getShownState(); shown[slug]=els.btc.checked; setShownState(shown);
        } else { els.btc.checked=false; }
        updateHash(); render();
      });

      els.lockBtn.addEventListener("click", ()=>{
        const slug=currentMerchant();
        if(merchantUnlocked(slug)){
          const pass=getPassState(); delete pass[slug]; setPassState(pass);
          const shown=getShownState(); shown[slug]=false; setShownState(shown);
          els.btc.checked=false;
          applyBtcVisibility(); updateHash(); render();
        }else{
          const name=merchantSlugToName(slug);
          const guess=(prompt(`Whisper the word for ${name}:`)||"").trim().toLowerCase();
          const target=(PASSPHRASE[slug]||"").toLowerCase();
          if(guess && guess===target){
            const pass=getPassState(); pass[slug]=true; setPassState(pass);
            const wantsBtc = new URLSearchParams(location.hash.slice(1)).get("btc")==="1";
            els.btc.disabled=false;
            els.btc.checked = wantsBtc || els.btc.checked;
            const shown=getShownState(); shown[slug]=els.btc.checked; setShownState(shown);
            applyBtcVisibility(); updateHash(); render();
          }else{
            alert('They shake their head. "Not today."');
          }
        }
      });

      updateHash();
    }

    function syncLockIcon(){
      const slug=currentMerchant();
      const open=merchantUnlocked(slug);
      els.lockBtn.classList.toggle("is-unlocked", open);
      els.lockBtn.title = open ? "Lock below-counter items" : "Unlock below-counter items";
      els.lockBtn.setAttribute("aria-label", els.lockBtn.title);
      const useEl = els.lockBtn.querySelector("use");
      if(useEl){ useEl.setAttribute("href", open ? "#ico-lock-open" : "#ico-lock-closed"); }
    }

    function applyBtcVisibility(){
      const slug=currentMerchant();

      if(!merchantHasBTC(slug)){
        els.btcWrap.hidden=true; els.btc.checked=false; els.btc.disabled=true; updateHash();
      } else {
        els.btcWrap.hidden=false;
        els.btc.disabled = !merchantUnlocked(slug);
        const shown=getShownState();
        els.btc.checked = merchantUnlocked(slug) ? !!shown[slug] : false;
        updateHash();
      }

      syncLockIcon();
    }

    function updateHash(){
      const p=new URLSearchParams();
      const slug=currentMerchant();
      p.set("merchant",slug);
      if(merchantHasBTC(slug) && merchantUnlocked(slug) && els.btc.checked){ p.set("btc","1"); }
      location.hash = p.toString();
    }

    // =========================
    // CREST LOADER (WebP only)
    // =========================
    function tryLoad(src){
      return new Promise(resolve=>{
        const im = new Image();
        im.onload = ()=>resolve(src);
        im.onerror = ()=>resolve(null);
        im.decoding = "async";
        im.src = src;
      });
    }
    async function setCrest(merchSlug, showBTC){
      const base = `assets/icons/${merchSlug}`;
      const candidates = [];
      if(showBTC) candidates.push(`${base}-btc.webp`);
      candidates.push(`${base}.webp`);
      let chosen = null;
      for(const c of candidates){
        const hit = await tryLoad(c);
        if(hit){ chosen = hit; break; }
      }
      const crest = document.getElementById("crest");
      const img = document.getElementById("crestImg");
      if(!crest || !img) return;
      if(chosen){
        img.src = chosen;
        img.alt = "";
        crest.hidden = false;
      }else{
        crest.hidden = true;
        img.removeAttribute("src");
      }
    }

    // =========================
    // SUBTITLE PICKER
    // =========================
    function getSubtitle(slug, showBTC){
      const rows = RAW.filter(r => slugify(r.merchant)===slug);
      if(!rows.length) return "";
      // sort by 'sort' asc (missing = Infinity), then by input order
      rows.sort((a,b)=>{
        const sa=Number.isFinite(a.sort)?a.sort:Infinity;
        const sb=Number.isFinite(b.sort)?b.sort:Infinity;
        if(sa!==sb) return sa-sb;
        return a.__i - b.__i;
      });
      if(showBTC){
        const btc = rows.find(r => r.subtitle_btc);
        if(btc && btc.subtitle_btc) return btc.subtitle_btc;
      }
      const base = rows.find(r => r.subtitle);
      return base ? base.subtitle : "";
    }

    // =========================
    // RENDER
    // =========================
    function render(){
      const merchSlug=currentMerchant();
      const merchName=merchantSlugToName(merchSlug);
      const showBTC = merchantHasBTC(merchSlug) && merchantUnlocked(merchSlug) && els.btc.checked;

      const skinClass=MERCHANT_SKIN[merchSlug]||"skin-parchment";
      els.paper.className=`paper ${skinClass}`;

      const rows = RAW.filter(r => slugify(r.merchant)===merchSlug && (showBTC || !r.is_btc));

      const sectionMap=new Map();
      for(const r of rows){
        const name=r.section||"";
        let s=sectionMap.get(name);
        if(!s){ s={name,items:[],firstIndex:r.__i}; sectionMap.set(name,s); }
        s.items.push(r);
        if(r.__i < s.firstIndex) s.firstIndex = r.__i;
      }

      const sections=[];
      for(const s of sectionMap.values()){
        s.items.sort((a,b)=>{
          const sa=Number.isFinite(a.sort)?a.sort:Infinity;
          const sb=Number.isFinite(b.sort)?b.sort:Infinity;
          if(sa!==sb) return sa-sb;
          return a.item.localeCompare(b.item);
        });
        if(!s.items.length) continue;
        const firstWithSort=s.items.find(x=>Number.isFinite(x.sort));
        s.key=Number.isFinite(firstWithSort?.sort)?firstWithSort.sort:Infinity;
        sections.push(s);
      }

      sections.sort((a,b)=>{
        if(a.key!==b.key) return a.key-b.key;
        if(a.name && !b.name) return -1;
        if(!a.name && b.name) return 1;
        const idx=a.firstIndex-b.firstIndex; if(idx) return idx;
        return a.name.localeCompare(b.name);
      });

      const subtitle = getSubtitle(merchSlug, showBTC);

      // Header with crest + subtitle
      let out = `
        <div class="head">
          <div class="title">
            <h2>${merchName}</h2>
            ${subtitle ? `<div class="subtitle">${subtitle}</div>` : ``}
          </div>
          <div class="crest" id="crest" hidden>
            <img id="crestImg" alt="" decoding="async">
          </div>
        </div>
      `;

      for(const sec of sections){
        const items=sec.items; if(!items||!items.length) continue;
        out+=`<section class="section">`;
        if(sec.name) out+=`<h3>${sec.name}</h3>`;
        out+=`<ul class="items">`;
        for(const row of items){
          const price = row.price_text ? addWrapHints(row.price_text) : fmtPriceCp(row.price_cp);
          const btcClass = row.is_btc ? " btc" : "";
          out += `
            <li class="item${btcClass}" aria-label="${row.item}">
              <div class="line name">
                <span>${row.item}</span>
                <span class="dots" aria-hidden="true"></span>
              </div>
              <div class="price">${price}</div>
              ${row.description ? `<div class="desc">${row.description}</div>` : ``}
            </li>`;
        }
        out+=`</ul></section>`;
      }
      out+=`<div class="footer"><div class="footLeft"></div><div class="footRight"></div></div>`;

      els.paperInner.innerHTML=out;

      // crest after DOM injection
      setCrest(merchSlug, showBTC);
    }

    (async function(){
      try{ await loadData(); }
      catch(e){
        console.error(e);
        $("#paperInner").innerHTML = `<h2>Phandalin Merchants</h2><p>We couldn't load the menu just now. Please try refresh.</p>`;
      }
    })();
  </script>
</body>
</html>
